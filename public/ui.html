<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lipikaar</title>
    <style>
        /* Basic styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: #FAFAF0; /* Off-white */
            color: #333;
        }

        h1 {
            font-family: 'serif';
            color: #A68B64; /* Muted brown */
            font-size: 20px;
            margin: 0 0 8px 0;
        }

        p {
            font-size: 12px;
            margin: 0 0 16px 0;
            color: #555;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        label {
            font-size: 11px;
            font-weight: 500;
            color: #333;
        }

        textarea, input, select {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            font-size: 13px;
            background-color: #fff;
            transition: border-color 0.2s;
        }
        
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: #A68B64;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            padding: 10px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button.primary {
            background-color: #A68B64; /* Muted brown */
            color: white;
        }

        button.primary:hover {
            background-color: #8c7354;
        }
        
        button.secondary {
             background-color: #e0e0e0;
             color: #333;
        }
        
        button.secondary:hover {
            background-color: #d0d0d0;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }
        
        .alert {
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            background-color: #F5F5DC; /* Soft beige */
            border: 1px solid #e7e7ce;
        }

        #unicode-preview {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            min-height: 100px;
            background-color: #fff;
            overflow-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>Lipikaar Converter</h1>
    <p>Convert legacy Malayalam text to Unicode and apply styles.</p>

    <div class="container">
        <div class="control-group">
            <label for="legacy-text">Legacy Text (Paste here)</label>
            <textarea id="legacy-text" placeholder="Paste legacy text..."></textarea>
        </div>

        <div class="control-group">
            <label>Unicode Preview</label>
            <div id="unicode-preview"></div>
        </div>

        <div id="alert-box" class="alert" style="display: none;"></div>

        <hr style="border: none; border-top: 1px solid #eee; margin: 8px 0;" />

        <div class="control-group">
            <label for="font-family">Font Family</label>
            <select id="font-family">
                <option>Noto Sans Malayalam</option>
                <option>Noto Serif Malayalam</option>
                <option>Chilanka</option>
                <option>Uroob</option>
            </select>
        </div>
        
        <div class="grid">
            <div class="control-group">
                <label for="font-size">Font Size (px)</label>
                <input id="font-size" type="number" value="16">
            </div>
            <div class="control-group">
                <label for="line-height">Line Height (px)</label>
                <input id="line-height" type="number" value="24" step="0.1">
            </div>
        </div>
        <div class="control-group">
            <label for="letter-spacing">Letter Spacing (px)</label>
            <input id="letter-spacing" type="number" value="0" step="0.1">
        </div>

        <div class="button-group">
            <button id="reset-button" class="secondary">Reset</button>
            <button id="apply-button" class="primary" disabled>Apply to Figma</button>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const legacyTextarea = document.getElementById('legacy-text');
        const unicodePreview = document.getElementById('unicode-preview');
        const applyButton = document.getElementById('apply-button');
        const resetButton = document.getElementById('reset-button');
        const alertBox = document.getElementById('alert-box');
        
        const fontFamilySelect = document.getElementById('font-family');
        const fontSizeInput = document.getElementById('font-size');
        const lineHeightInput = document.getElementById('line-height');
        const letterSpacingInput = document.getElementById('letter-spacing');

        // Store the node ID
        let selectedNodeId = null;

        // --- MALAYALAM CONVERSION LOGIC ---
        // Simplified mapping for a generic legacy font.
        const legacyMap = {
            'A': 'അ', 'B': 'ആ', 'C': 'ഇ', 'D': 'ഈ', 'E': 'ഉ', 'F': 'ഊ', 'G': 'ഋ', 'H': 'എ', 'I': 'ഏ',
            'J': 'ഐ', 'K': 'ഒ', 'L': 'ഓ', 'M': 'ഔ', 'k': 'ക', 'J': 'ഖ', 'g': 'ഗ', 'L': 'ഘ', '§': 'ങ',
            'N': 'ച', 'O': 'ഛ', 'P': 'ജ', 'Q': 'ഝ', 'R': 'ഞ', 'S': 'ട', 'T': 'ഠ', 'U': 'ഡ', 'V': 'ഢ',
            'W': 'ണ', 'X': 'ത', 'Y': 'ഥ', 'Z': 'ദ', 'å': 'ധ', 'Ä': 'ന', ']': 'പ', '^': 'ഫ', '_': 'ബ',
            '`': 'ഭ', 'a': 'മ', 'b': 'യ', 'c': 'ര', 'd': 'ല', 'e': 'വ', 'f': 'ശ', 'v': 'ഷ', 's': 'സ',
            'h': 'ഹ', 'Ê': 'ള', 'g': 'ഴ', 'É': 'റ', 'x': 'റ്റ', '³': 'ൺ', '²': 'ൻ', 'þ': 'ർ',
            'Ü': 'ൽ', 'Þ': 'ൾ', 'w': 'ം', 't': 'ഃ', 'm': 'ാ', 'n': 'ി', 'o': 'ീ', 'p': 'ു', 'q': 'ൂ',
            'r': 'ൃ', 's': 'െ', 't': 'േ', 'u': 'ൈ', 'x': 'ൊ', 'y': 'ോ', 'z': 'ൌ', 'd': '്'
        };

        const conjunctMap = {
            'k d k': 'ക്ക', '§ d k': 'ങ്ക', 'N d N': 'ച്ച', 'P d P': 'ജ്ജ', 'R d N': 'ഞ്ച', 'R d P': 'ഞ്ജ',
            'W d U': 'ണ്ഡ', 'Ä d X': 'ന്ത', 'a d _': 'മ്പ', 'i d N': 'ശ്ച', 'k d j': 'ക്ഷ', 'k d s': 'ക്സ'
        };
        
        function convertToUnicode(text) {
            let convertedText = text;
            Object.entries(conjunctMap).forEach(([key, value]) => {
                const regex = new RegExp(key.split('').map(char => `\\${char}`).join(''), 'g');
                convertedText = convertedText.replace(regex, value);
            });

            let result = '';
            for (let i = 0; i < convertedText.length; i++) {
                const char = convertedText[i];
                result += legacyMap[char] || char;
            }
            result = result.replace(/ര്(?![ാ-്])/g, 'ർ');
            return result;
        }

        // --- UI LOGIC ---
        function showAlert(message) {
            alertBox.textContent = message;
            alertBox.style.display = message ? 'block' : 'none';
        }

        function updatePreview() {
            const legacy = legacyTextarea.value;
            const unicode = convertToUnicode(legacy);
            unicodePreview.textContent = unicode;
            
            // Also apply typography to preview
            unicodePreview.style.fontFamily = `'${fontFamilySelect.value}', sans-serif`;
            unicodePreview.style.fontSize = `${fontSizeInput.value}px`;
            unicodePreview.style.lineHeight = `${lineHeightInput.value}px`;
            unicodePreview.style.letterSpacing = `${letterSpacingInput.value}px`;
        }

        // --- EVENT LISTENERS ---
        legacyTextarea.addEventListener('input', updatePreview);
        fontFamilySelect.addEventListener('change', updatePreview);
        fontSizeInput.addEventListener('input', updatePreview);
        lineHeightInput.addEventListener('input', updatePreview);
        letterSpacingInput.addEventListener('input', updatePreview);

        resetButton.onclick = () => {
            legacyTextarea.value = '';
            unicodePreview.textContent = '';
            fontSizeInput.value = 16;
            lineHeightInput.value = 24;
            letterSpacingInput.value = 0;
            fontFamilySelect.value = 'Noto Sans Malayalam';
            showAlert('Please select a single text layer in Figma.');
            applyButton.disabled = true;
        }

        applyButton.onclick = () => {
            const unicodeText = unicodePreview.textContent;
            const payload = {
                nodeId: selectedNodeId,
                unicodeText: unicodeText,
                fontFamily: fontFamilySelect.value,
                fontSize: parseFloat(fontSizeInput.value),
                lineHeight: parseFloat(lineHeightInput.value),
                letterSpacing: parseFloat(letterSpacingInput.value)
            };
            parent.postMessage({ pluginMessage: { type: 'apply-text-and-typography', payload } }, '*');
        }

        // --- LISTEN FOR MESSAGES FROM CODE.JS ---
        window.onmessage = event => {
            const msg = event.data.pluginMessage;
            if (msg.type === 'selection-change') {
                const { hasTextNode, legacyText, nodeId } = msg.payload;
                if (hasTextNode) {
                    legacyTextarea.value = legacyText;
                    selectedNodeId = nodeId;
                    applyButton.disabled = false;
                    showAlert('Text layer loaded. You can now convert and apply changes.');
                    updatePreview();
                } else {
                    legacyTextarea.value = '';
                    selectedNodeId = null;
                    applyButton.disabled = true;
                    showAlert('Please select a single text layer in Figma.');
                    updatePreview();
                }
            }
        };

        // Initial state
        showAlert('Please select a single text layer in Figma.');

    </script>
</body>
</html>
