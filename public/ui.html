<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lipikaar | Malayalam Font Helper</title>
    <style>
        :root {
            --bg-color: #FAFAF0;
            --primary-color: #F5F5DC;
            --accent-color: #A68B64;
            --text-color: #333;
            --border-color: #EAEAEA;
            --button-text-color: #FFFFFF;
            --font-body: 'Inter', sans-serif;
            --font-malayalam: 'Noto Sans Malayalam', sans-serif;
        }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 16px;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        label {
            font-weight: 600;
        }
        select, button {
            width: 100%;
            height: 36px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: #FFF;
            padding: 0 8px;
            font-family: var(--font-body);
            font-size: 13px;
        }
        button {
            background-color: var(--accent-color);
            color: var(--button-text-color);
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #error-message {
            color: #D9534F;
            background-color: #FADBD8;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            display: none; /* Initially hidden */
        }
        .info-box {
            font-size: 11px;
            color: #555;
            background-color: var(--primary-color);
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid var(--accent-color);
        }
        .font-mode-selector {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .font-mode-selector button {
            flex: 1;
            border-radius: 0;
            background-color: #fff;
            color: var(--text-color);
            border: none;
            height: 32px;
            font-weight: normal;
        }
        .font-mode-selector button.active {
            background-color: var(--accent-color);
            color: var(--button-text-color);
            font-weight: 600;
        }
        #original-text-preview {
            height: 60px;
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            font-family: var(--font-malayalam);
            overflow-y: auto;
            word-break: break-all;
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="error-message">Please select a single text layer in Figma.</div>

    <div class="section">
        <label>Font Mode</label>
        <div class="font-mode-selector">
            <button id="mode-unicode" class="active">Unicode</button>
            <button id="mode-legacy">Legacy (FML)</button>
        </div>
    </div>
    
    <div id="legacy-info" class="info-box" style="display: none;">
        Legacy fonts like FML require text to be converted for correct rendering.
    </div>
    
    <div class="section">
        <label>Font Family</label>
        <select id="font-family-select"></select>
    </div>

    <div class="section">
        <label>Original Text Preview</label>
        <div id="original-text-preview">(No text selected)</div>
    </div>

    <button id="apply-button" disabled>Convert & Apply</button>
    
    <script>
        const modeUnicodeBtn = document.getElementById('mode-unicode');
        const modeLegacyBtn = document.getElementById('mode-legacy');
        const legacyInfoBox = document.getElementById('legacy-info');
        const fontFamilySelect = document.getElementById('font-family-select');
        const applyButton = document.getElementById('apply-button');
        const errorMessage = document.getElementById('error-message');
        const originalTextPreview = document.getElementById('original-text-preview');
        
        let currentMode = 'unicode';
        let originalText = '';
        let isNodeSelected = false;

        const fonts = {
            unicode: [
                { name: 'Noto Sans Malayalam', value: { family: 'Noto Sans Malayalam', style: 'Regular' } },
                { name: 'Noto Serif Malayalam', value: { family: 'Noto Serif Malayalam', style: 'Regular' } },
                { name: 'Chilanka', value: { family: 'Chilanka', style: 'Regular' } },
            ],
            legacy: [
                { name: 'FML Chithra', value: { family: 'FML-Chithra', style: 'Regular' } },
                { name: 'FML Gayathri', value: { family: 'FML-Gayathri', style: 'Regular' } },
            ]
        };

        function updateFontDropdown() {
            fontFamilySelect.innerHTML = '';
            const fontList = fonts[currentMode];
            fontList.forEach(font => {
                const option = document.createElement('option');
                option.textContent = font.name;
                option.value = JSON.stringify(font.value);
                fontFamilySelect.appendChild(option);
            });
        }
        
        function setMode(mode) {
            currentMode = mode;
            modeUnicodeBtn.classList.toggle('active', mode === 'unicode');
            modeLegacyBtn.classList.toggle('active', mode === 'legacy');
            legacyInfoBox.style.display = mode === 'legacy' ? 'block' : 'none';
            updateFontDropdown();
        }

        modeUnicodeBtn.onclick = () => setMode('unicode');
        modeLegacyBtn.onclick = () => setMode('legacy');
        
        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (msg.type === 'selection-change') {
                isNodeSelected = !!msg.nodeId;
                originalText = msg.text || '';
                
                errorMessage.style.display = isNodeSelected ? 'none' : 'block';
                applyButton.disabled = !isNodeSelected;
                
                if (isNodeSelected) {
                    originalTextPreview.textContent = originalText;
                } else {
                    originalTextPreview.textContent = '(No text selected)';
                }
            }
        };

        applyButton.onclick = () => {
            if (!isNodeSelected || !originalText) {
                parent.postMessage({ pluginMessage: { type: 'notify', message: 'No text content to convert.', isError: true } }, '*');
                return;
            }

            const selectedFont = JSON.parse(fontFamilySelect.value);
            let convertedText = originalText;
            
            if (currentMode === 'legacy') {
                convertedText = convertUnicodeToFml(originalText);
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'apply-font-and-text',
                    font: selectedFont,
                    convertedText: convertedText
                }
            }, '*');
        };

        function convertUnicodeToFml(unicodeText) {
            // This is a simplified Unicode to FML converter.
            // A production version would require a much more extensive and carefully ordered set of rules.
            let text = unicodeText;
            const mapping = {
                // Vowels
                'അ': 'A', 'ആ': 'B', 'ഇ': 'C', 'ഈ': 'D', 'ഉ': 'E', 'ഊ': 'F', 'ഋ': 'G',
                'എ': 'H', 'ഏ': 'I', 'ഐ': 'sI', 'ഒ': 'J', 'ഓ': 'K', 'ഔ': 'Ku',

                // Consonants
                'ക': 'k', 'ഖ': 'J', 'ഗ': 'g', 'ഘ': 'L', 'ങ': '§',
                'ച': 'N', 'ഛ': 'O', 'ജ': 'P', 'ഝ': 'Q', 'ഞ': 'R',
                'ട': 'S', 'ഠ': 'T', 'ഡ': 'U', 'ഢ': 'V', 'ണ': 'W',
                'ത': 'X', 'ഥ': 'Y', 'ദ': 'Z', 'ധ': 'À', 'ന': 'n',
                'പ': ']', 'ഫ': '^', 'ബ': '_', 'ഭ': '`', 'മ': 'a',
                'യ': 'b', 'ര': 'c', 'ല': 'e', 'വ': 'h', 'ശ': 'i', 'ഷ': 'j', 'സ': 'k',
                'ഹ': 'l', 'ള': 'f', 'ഴ': 'g', 'റ': 'd',

                // Chandrakkala (Virama) and vowel signs must be handled carefully.
                // Replace vowel signs first.
                'ാ': 'm', 'ി': 'n', 'ീ': 'o', 'ു': 'p', 'ൂ': 'q', 'ൃ': 'r',
                'െ': 's', 'േ': 't', 'ൈ': 'ss',
                'ൊ': 'sm', 'ോ': 'tm', 'ൌ': 'u', 'ം': 'w', 'ഃ': 'x',

                // Conjuncts and Chillu need specific rules and reordering.
                // This is a highly complex process. We'll handle a few common cases.
                // Re-ordering for 'ര' sign (reph).
                '്ര': 'c',
                '്ര്': 'À', // Special case handling might be needed.

                // Chillu letters
                'ൻ': '³', 'ർ': 'À', 'ൽ': 'Â', 'ൾ': 'Ä', 'ൺ': '¬',

                // Virama (Chandrakkala)
                '്': 'v',
            };

            // This is a very simplified conversion. The order of replacement is critical.
            // A more robust implementation would parse the text logically.

            // First, deal with combinations that reorder characters.
            // Example: െ + ക -> കെ ('s' must come before 'k')
            text = text.replace(/െ(.)/g, 's$1');
            text = text.replace(/േ(.)/g, 't$1');
            text = text.replace(/ൈ(.)/g, 'ss$1');
            text = text.replace(/ൊ(.)/g, 'sm$1');
            text = text.replace(/ോ(.)/g, 'tm$1');

            // Replace conjuncts (example: ക്ക = ക + ് + ക)
            text = text.replace(/ക്ക/g, "¡");
            text = text.replace(/ച്ച/g, "¨");
            text = text.replace(/ട്ട/g, "«");
            text = text.replace(/ത്ത/g, "Ù");
            text = text.replace(/പ്പ/g, "¸");
            text = text.replace(/യ്യ/g, "b-");
            text = text.replace(/വ്വ/g, "h-");
            text = text.replace(/ശ്ശ/g, "i-");
            text = text.replace(/സ്സ/g, "k-");
            text = text.replace(/ള്ള/g, "f-");

            // After handling complex reordering, do single character mapping
            let result = '';
            for (const char of text) {
                result += mapping[char] || char;
            }

            // A final cleanup might be necessary for specific FML font quirks.
            return result;
        }

        // Initialize
        setMode('unicode');

    </script>
</body>
</html>